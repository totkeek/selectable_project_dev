設問が1以上表示される画面がn(0 < n)ページあり。1ページ目からnページ目にかけて1ページづつ遷移する。戻る場合も同様。
nページ内の設問に回答したのち、つぎの画面へ遷移すると結果画面が表示される

要件として、設問の回答状況によって、設問が表示非表示、別の設問が表示される制約がある。また、設問の回答状況によって設問内の選択肢の種類、順序、グルーピングが変化する

階層としては、画面→設問→選択肢グループ→選択肢ですね。
                    ↓→グルーピング

イメージとしては、
設問に回答
↓
設問の回答と過去に回答した他の回答状況を合わせて、次の設問を決定
↓
設問
↓
設問の回答と過去に回答した他の回答状況を合わせて、設問に表示する選択肢グループを決定
↓
設問の回答と過去に回答した他の回答状況を合わせて、設問に表示する選択肢をどのようにグルーピングとフィルタリングするかを決定
↓
選択肢をグルーピングとフィルタリングを行いながらソートする
↓
設問と選択肢を表示

選択肢の表示順についてのイメージはこんなかんじ

選択肢グループ内には、選択肢があり表示順がきまっている。
1つの設問に選択肢グループが2つ以上ある場合、グループ単位で表示順がある。(回答状況によって、設問XではグループAとグループBを1,2の順で並べますみたいな)なので、グループ単位を管理するテーブルや設問そのものには表示順はない
なので、グループ単位の表示順→グループ内の選択肢の表示順です。このソートが終わったあとに、ソート順をくずさないようにグルーピングを行う。

グルーピングについては、そもそも選択肢が親子構造なのを利用します。例えば水栓は、メーカ→図番→品番 水栓管理番号→図番→品番 の親子構造があります。メーカ、水栓管理番号、図番、品番のうち、基本的に選択肢として表示するのは品番のみですが、他の要素も選択肢として登録します。

---

## 実装予定機能のDB設計案

### 1. 回答状況による選択肢グループ決定

**目的**: 設問の回答内容に応じて、表示する選択肢グループを動的に切り替える

| テーブル名 | 説明 | 主要カラム |
|-----------|------|-----------|
| `question_group_rules` | 設問に対する選択肢グループ表示ルール | `id`, `project_id`, `question_id`, `priority` |
| `question_group_conditions` | グループ表示の条件 | `id`, `rule_id`, `condition_question`, `condition_operator`, `logical_operator`, `condition_group` |
| `question_group_condition_values` | 条件の値 | `id`, `condition_id`, `value` |
| `question_group_actions` | 条件を満たした場合のアクション | `id`, `rule_id`, `target_group_id`, `sort_order` |

**動作イメージ**:
- Q1で「キッチン」を選択 → Q2には「キッチン用グループA」「キッチン用グループB」を表示
- Q1で「浴室」を選択 → Q2には「浴室用グループC」を表示

### 2. 回答状況による選択肢グルーピング方法の決定

**目的**: 同じ選択肢でも、回答状況によって表示のグルーピング方法を変える

| テーブル名 | 説明 | 主要カラム |
|-----------|------|-----------|
| `choice_grouping_rules` | 選択肢のグルーピング表示ルール | `id`, `project_id`, `question_id`, `priority` |
| `choice_grouping_conditions` | グルーピング条件 | `id`, `rule_id`, `condition_question`, `condition_operator`, `logical_operator`, `condition_group` |
| `choice_grouping_condition_values` | 条件の値 | `id`, `condition_id`, `value` |
| `choice_grouping_config` | グルーピング設定 | `id`, `rule_id`, `group_by_attribute_id`, `display_level`, `show_parent_label` |

**動作イメージ**:
- 予算「高」選択時 → 水栓を「メーカー別」にグルーピング表示
  ```
  [TOTO]
    - 品番A
    - 品番B
  [LIXIL]
    - 品番C
  ```
- 予算「低」選択時 → 水栓を「図番別」にグルーピング表示
  ```
  [図番X]
    - 品番A
    - 品番D
  [図番Y]
    - 品番E
  ```

### 3. 既存テーブルの実装状況

| 機能 | 実装状況 | 使用テーブル |
|------|---------|-------------|
| ✅ 回答状況による設問の表示/非表示 | **実装済み** | `dynamic_question_rules`, `dynamic_question_conditions`, `dynamic_question_condition_values` |
| ⏳ 回答状況による選択肢グループ決定 | **未実装** | (上記テーブル案を参照) |
| ⏳ 回答状況によるグルーピング方法決定 | **未実装** | (上記テーブル案を参照) |

---

## DB設計の修正事項（TODO）

### 外部キー制約の追加

- [ ] **`dynamic_question_conditions.condition_question`** に外部キー制約を追加
  - 参照先: `question(id)`
  - 現状、条件対象の設問IDが外部キー未設定のため整合性が保証されていない

```sql
ALTER TABLE `dynamic_question_conditions`
ADD CONSTRAINT `FK_dynamic_question_conditions_question`
FOREIGN KEY (`condition_question`) REFERENCES `question` (`id`);
```

### その他の改善候補

- [ ] `dynamic_question_rules.name` のデータ型を `VARCHAR(50)` に変更（現在`INT`になっている）
- [ ] `view_structure_potision` のスペルを `view_structure_position` に修正
- [ ] `choice_family.child_choiceid` を `child_choice_id` に修正（命名規則統一）
- [ ] `session.session_key` を `CHAR(255)` → `VARCHAR(255)` に変更（容量最適化）

---

## 補足: ルールエンジンの共通構造

上記3つの機能（設問表示・グループ決定・グルーピング方法）は全て同じパターンで設計可能:

```
ルールテーブル (何に対するルールか)
  ├─ 条件テーブル (どんな条件か)
  │   └─ 条件値テーブル (具体的な値)
  └─ アクションテーブル (条件を満たしたら何をするか)
```

このパターンを統一することで、実装やメンテナンスが容易になる。

